import openAi from 'openai';
import itineraryModel from '../models/itenary.model.js';
import axios from 'axios';
import { jsonrepair } from 'jsonrepair';
import gemini1 from 'gemini-ai'

class ItineraryService {

    async geminiTravelPlan(req) {
        const gemini = new gemini1(process.env.geminiAi)
        const response = await gemini.ask("hello")
        return response
    }



    async travelPlan(req) {
        try {
            const { travelType, location, startDate, endDate, budget } = req.body;

            console.log(req.body);

            const client = new openAi({
                apiKey: process.env.chatAi,
                baseURL: "https://openrouter.ai/api/v1",
            });

            const response = await client.chat.completions.create({
                model: "deepseek/deepseek-r1:free",
                messages: [
                    {
                        role: "user",
                        content: `Create a travel itinerary for travel type ${travelType} for the location ${location} from date (${startDate} to date ${endDate},and budget of  $${budget}). Return JSON:
                        {
                          "days": [{
                            "date": "YYYY-MM-DD",
                            "plan": ["activity/place 1", "activity/place 2"],
                            "cost": 0,
                            "tip": "daily tip"
                          }],
                          "total": {
                            "stay": 0,
                            "food": 0,
                            "travel": 0
                          },
                          "tips": ["general tip 1", "general tip 2"]
                        }`,
                    },
                ],
            });

            if (!response || !response.choices || response.choices.length === 0) {
                throw new Error("No response from OpenAI");
            }

            let content = response.choices[0].message.content;
            console.log("OpenAI Response Content:", content);

            if (!content) {
                throw new Error("Empty response content from OpenAI");
            }

            let jsonData;
            try {
                jsonData = JSON.parse(jsonrepair(content));
            } catch (error) {
                console.error("Error parsing JSON:", error);
                throw new Error("Invalid JSON response from OpenAI");
            }

            console.log("Parsed JSON Data:", jsonData);

            if (!jsonData) {
                throw new Error("Parsed JSON data is empty or invalid");
            }

            let payload = req.body;
            payload.itinerary = jsonData;
            let newTravelPlan = await this.saveItinerary(payload);

            return { message: "Success", data: jsonData, travelPlan: newTravelPlan };

        } catch (error) {
            console.error("Error in travelPlan method:", error);
            throw error;
        }

    }

    async saveItinerary(payload) {
        let newTravelPlan = await itineraryModel.create(payload);
        if (newTravelPlan) {
            // console.log("Travel Plan is saved ", newTravelPlan);
            return "saved";
        } else {
            let error = new Error("Unable to save itinerary");
            error.statusCode = 400;
            throw error;
        }
    }

    async getAllItinerary() {
        let alltravelPlan = await itineraryModel.find();
        // console.log("Fetched Itineraries from Database:", alltravelPlan);
        if (alltravelPlan) {
            return alltravelPlan;
        } else {
            let err = new Error("Travel Plans not found");
            err.statusCode = 404;
            throw err;
        }
    }
    async deleteItinerary(id) {
        let deletedTravelPlan = await itineraryModel.findByIdAndDelete(id);
        if (deletedTravelPlan) {
            return deletedTravelPlan;
        } else {
            let err = new Error("Travel Plans not found");
            err.statusCode = 404;
            throw err;
        }
    }

    async getAutocomplete(req) {
        try {
            const { location } = req.query;
            const response = await axios.get('https://maps.googleapis.com/maps/api/place/autocomplete/json', {
                params: {
                    input: location,
                    key: process.env.MAP_API,
                },
            });
            return response.data.predictions.map((prediction) => prediction.description);
        } catch (error) {
            console.error("Error fetching places:", error);
            throw error;
        }
    }

}

export default new ItineraryService();